<!DOCTYPE html>
<head>
	<meta charset="utf-8">
	<title>The First Commit</title>
	<meta name="description" content="">
	<meta name="author" content="Matt Parmett">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link rel="stylesheet" href="../../stylesheets/base.css">
	<link rel="stylesheet" href="../../stylesheets/skeleton.css">
	<link rel="stylesheet" href="../../stylesheets/layout.css">
	<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/default.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js"></script>
	<script>hljs.highlightAll();</script>
</head>

<body>
	<div class="container">
		<div class="sixteen columns">
			<h1 id="title" class="add-top">The First Commit</h1>
			<p><em>September 20, 2022<br />
					<a href="pyle_index.html">Return to blog index</a></em></p>
			<p>In this installment of our <code>pyle</code> journey, our aim is to
get enough code written so that <code>pyle</code> can store itself as a
valid git commit. We want to get to this point as quickly as possible,
so we’ll minimize work on other features while our project is not under
version control. Otherwise, we wouldn’t be able to make use of version
control during development!</p>
<p>In particular, we are going to skip several features that are
must-haves for a full-featured git clone, but which aren’t actually
important to us at this early stage of the project:</p>
<ol type="1">
<li>We won’t have support for subdirectories, executable files, or
symlinks. This will allow us to simplify our representation of trees in
early versions of <code>pyle</code>.</li>
<li>Our early versions of <code>pyle</code> won’t include the
<code>add</code> command, or any concept of the git index. Instead, we
will only support committing changes to the repo directly. While this
isn’t ideal in a normal project scenario, this should be fine for
purposes of getting our early code into version control.</li>
<li>Our <code>commit</code> command won’t have any command line flags or
arguments - we can read from environment variables or stdin as
needed.</li>
</ol>
<p>That’s quite a bit that will be missing from our early version of
<code>pyle</code>…all the motivation to get those features built so we
can use them!</p>
<h3 id="initializing-a-repo">Initializing a repo</h3>
<p>The beginning of this post was actually a bit aspirational - our
first step won’t even be creating a commit. Before we do that, we’ll
need to first actually <em>create</em> our repo.</p>
<p>That means we’ll need to build the <code>init</code> function to set
up our repo structure. In our <a href="">last installment</a>, we
examined the structure of a git repo; we’ll now put that knowledge to
use.</p>
<p>After creating the <code>.git</code> directory, our <code>init</code>
command will need to create the <code>objects</code> and
<code>refs</code> directories, as well as a <code>HEAD</code> file that
symrefs to a file in the <code>refs</code> directory.</p>
<p>Given all the critical functionality highlighted above that will be
excluded from our v0, I figured it went without saying that we’ll be
foregoing support for branches in our initial version of
<code>pyle</code>. Instead, we’ll simply have <code>HEAD</code> point to
a specific commit ID. When our repo is initialized, it won’t contain any
commits - so we don’t actually need a <code>HEAD</code> file upon
initialization of the repo.</p>
<p>Our <code>init</code> command should be invoked in a similar manner
as git’s own <code>init</code> command. We should be able to run:</p>
<div class="sourceCode" id="cb1"><pre
class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">python</span> pyle.py init path/to/repo/directory</span></code></pre></div>
<p>to create a repo in the given directory. If a directory is not
provided, we should create the repo in the current working
directory.</p>
<p>With these requirements spelled out, we can create
<code>pyle.py</code> and begin to write our init functionality:</p>
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pyle.py</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os.path</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> PurePath</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> boltons <span class="im">import</span> fileutils</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Discard the name of the script - we know we are running pyle!</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>sys.argv.pop(<span class="dv">0</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Retrieve the command passed to the pyle script</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>command <span class="op">=</span> sys.argv.pop(<span class="dv">0</span>)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> command <span class="op">==</span> <span class="st">&quot;init&quot;</span>:</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Retrieve the repo directory argument,</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># or use the current dir if no dir was provided</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span>:</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    path <span class="op">=</span> sys.argv[<span class="dv">0</span>]</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">except</span> <span class="pp">IndexError</span>:</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    path <span class="op">=</span> os.getcwd()</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Standardize the given path and set .git folder path</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>  repo_path <span class="op">=</span> PurePath(os.path.abspath(path))</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>  git_path <span class="op">=</span> repo_path.joinpath(<span class="st">&#39;.git&#39;</span>)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> dir_name <span class="kw">in</span> (<span class="st">&quot;objects&quot;</span>, <span class="st">&quot;refs&quot;</span>):</span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create dirs, creating parent dirs as needed</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    dir_path <span class="op">=</span> git_path.joinpath(dir_name)</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>      fileutils.mkdir_p(dir_path)</span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">OSError</span> <span class="im">as</span> e:</span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Exit with fatal error if we can&#39;t create required dirs</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>      <span class="bu">print</span>(<span class="ss">f&quot;fatal: </span><span class="sc">{</span> e <span class="sc">}</span><span class="ss">&quot;</span>, <span class="bu">file</span><span class="op">=</span>sys.stderr)</span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a>      exit(<span class="dv">1</span>)</span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="ss">f&quot;Initialized empty pyle repository in </span><span class="sc">{</span> git_path <span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>  exit(<span class="dv">0</span>)</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We don&#39;t yet support any commands aside from init</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>  <span class="bu">print</span>(<span class="ss">f&quot;pyle: </span><span class="sc">{</span> command <span class="sc">}</span><span class="ss"> is not a pyle command.&quot;</span>, <span class="bu">file</span><span class="op">=</span>sys.stderr)</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>  exit(<span class="dv">1</span>)</span></code></pre></div>
<p>Our script does a few key things: 
	<ol type="1">
		<li>Parses the command line arguments passed to <code>pyle.py</code> to identify the command passed
to the script </li>
		<li>Checks if the <code>init</code> command was passed </li>
		<li>Gets the repo path passed by the user, defaulting to the current working
directory if no path was given </li>
		<li>Creates the <code>objects</code> and
			<code>refs</code> directories</p></li></ol>
<p>Now that we have our repo structure set up, we are ready to make our
first commit.</p>
<h3 id="the-commit-command">The <code>commit</code> command</h3>
<p>As we covered above, we want to write just enough code to store what
we’ve written so far as a valid commit. We won’t bother with the
<code>add</code> command or the git index just yet - we’ll commit our
working directory right into the repo.</p>
<p>To add support for a <code>commit</code> command, we’ll need to add a
branch to our if statement. We’ll also create a <code>Workspace</code>
class that will be responsible for the files in the working tree (in
other words, all the files the user can edit).</p>
<p>Let’s first update our if statement into a match/case statement and
add support for the <code>commit</code> command:</p>
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pyle.py</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ...</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="cf">match</span> command:</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="st">&#39;init&#39;</span>:</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>      path <span class="op">=</span> sys.argv[<span class="dv">0</span>]</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">IndexError</span>:</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>      path <span class="op">=</span> os.getcwd()</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    repo_path <span class="op">=</span> PurePath(os.path.abspath(path))</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    git_path <span class="op">=</span> repo_path.joinpath(<span class="st">&#39;.git&#39;</span>)</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> dir_name <span class="kw">in</span> (<span class="st">&#39;objects&#39;</span>, <span class="st">&#39;refs&#39;</span>):</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>      dir_path <span class="op">=</span> git_path.joinpath(dir_name)</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>      <span class="cf">try</span>:</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>        fileutils.mkdir_p(dir_path)</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>      <span class="cf">except</span> <span class="pp">OSError</span> <span class="im">as</span> e:</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;fatal: </span><span class="sc">{</span> e <span class="sc">}</span><span class="ss">&quot;</span>, <span class="bu">file</span><span class="op">=</span>sys.stderr)</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>        exit(<span class="dv">1</span>)</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Initialized empty pyle repository in </span><span class="sc">{</span> git_path <span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    exit(<span class="dv">0</span>)</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> <span class="st">&#39;commit&#39;</span>:</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Assumes cwd is the location of the repo</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    root_path <span class="op">=</span> PurePath(os.getcwd())</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    git_path <span class="op">=</span> root_path.joinpath(<span class="st">&#39;.git&#39;</span>)</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    db_path <span class="op">=</span> git_path.joinpath(<span class="st">&#39;objects&#39;</span>)</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>    workspace <span class="op">=</span> Workspace(root_path)</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(workspace.list_files()</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">case</span> _:</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;pyle: </span><span class="sc">{</span> command <span class="sc">}</span><span class="ss"> is not a pyle command.&quot;</span>, <span class="bu">file</span><span class="op">=</span>sys.stderr)</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    exit(<span class="dv">1</span>)</span></code></pre></div>
<p>In this initial implementation of the commit command, we’ll simply
list the files in the workspace rather than storing them in the git
database.</p>
<p>Now we need to create the <code>Workspace</code> class in
<code>workspace.py</code>:</p>
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># workspace.py</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Workspace:</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="co">  Responsible for the files in the working tree</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="co">  (files that are edited directly, not those included</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="co">  in the .git folder)</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  IGNORE <span class="op">=</span> [<span class="st">&#39;.&#39;</span>, <span class="st">&#39;..&#39;</span>, <span class="st">&#39;.git&#39;</span>, <span class="st">&#39;venv&#39;</span>, <span class="st">&#39;__pycache__&#39;</span>]</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, workspace_path):</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.path <span class="op">=</span> workspace_path</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> list_files(<span class="va">self</span>):</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a><span class="co">    Lists all working files in the project.</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="co">    :return: list of all working files in the project</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [<span class="bu">file</span> <span class="cf">for</span> <span class="bu">file</span> <span class="kw">in</span> os.listdir(<span class="va">self</span>.path)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>              <span class="cf">if</span> <span class="bu">file</span> <span class="kw">not</span> <span class="kw">in</span> <span class="va">self</span>.IGNORE]</span></code></pre></div>
<p>Right now, the <code>Workspace</code> class is self-explanatory - we
create a workspace at the given directory path, and we are able to list
all working files in the workspace that do not match the paths we are
excluding.</p>
<p>After confirming we can successfully list the files in our workspace,
we can move on to storing the contents of our workspace as blobs in our
git database.</p>
<h3 id="blobs-your-uncle">Blob’s your uncle</h3>
<p>We now have the ability to recognize the <code>commit</code> command
and manipulate files in our workspace, but we still can’t store anything
in our git database.</p>
<p>As we saw in the last post, files are stored in the git database as
blobs that contain the file’s contents in a specific format. So let’s
stub out a <code>Blob</code> class that will represent an object in our
git database:</p>
<div class="sourceCode" id="cb5"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># blob.py</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Blob:</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="co">  Represents a git blob (file object).</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">  Currently a basic class that wraps</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="co">  a string representing file contents</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="co">  and provides some convenience methods.</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Object ID is the SHA-1 hash of this object</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  object_id <span class="op">=</span> <span class="va">None</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, data):</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.data <span class="op">=</span> data</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> get_type(<span class="va">self</span>):</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">&quot;blob&quot;</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__str__</span>(<span class="va">self</span>):</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">self</span>.data</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__repr__</span>(<span class="va">self</span>):</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f&quot;blob: </span><span class="sc">{</span> <span class="va">self</span><span class="sc">.</span>data <span class="sc">}</span><span class="ss">&quot;</span></span></code></pre></div>
<p>Now that we have a way to represent blobs, we need a way to manage
and interface with the git database. Let’s create a
<code>Database</code> class that will handle storage of our content in
the <code>.git/objects</code> directory.</p>
<p>In our early <code>pyle</code> implementation, the
<code>Database</code> class will need to take our <code>Blob</code>s and
store them on disk in the git database format. As we’ve seen, objects
are stored in git by serializing them and prefixing the result with the
object’s type, a space, then length of the file contents, and a null
byte. This content is then hashed with SHA-1 to compute the object’s ID.
Finally, the entire string of content is compressed and written to disk
in a directory based on its hash.</p>
<p>Let’s stub out a <code>Database</code> class with basic
functionality:</p>
<div class="sourceCode" id="cb6"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># database.py</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> PurePath</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Database:</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co">  Manages the git database.</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="co">  Currently able to write objects</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co">  to the database.</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, pathname):</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="co">    Creates a Database manager for the database</span></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a><span class="co">    located at the given pathname.</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="co">    :param pathname: path of the git database</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">type</span>(pathname) <span class="kw">is</span> PurePath:</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span>.pathname <span class="op">=</span> pathname</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>      <span class="va">self</span>.pathname <span class="op">=</span> PurePath(pathname)</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> store(<span class="va">self</span>, obj):</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a><span class="co">    Stores the given object in this git database.</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a><span class="co">    :param obj: object to store in the database</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a><span class="co">    :return: None</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> _write_object(<span class="va">self</span>, oid, content):</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a><span class="co">    Writes the given content to the database,</span></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a><span class="co">    using the given object id to create</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a><span class="co">    the appropriate directory for the object.</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a><span class="co">    :param oid: object id of the object being written</span></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a><span class="co">    :param content: content being written to the database</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a><span class="co">    :return: None</span></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span></code></pre></div>
<p>At the most basic level, our <code>Database</code> class will need to
be able to write objects to the git database. We have two functions
above that will handle storing objects in the database:</p>
<ol type="1">
<li><code>store(self, obj)</code> will be the public-facing API for
storing objects. This method will need to encode the object’s file
contents, create the blob contents according to the process we outlined
above, SHA-1 hash the contents, and write the object to disk in the
correct directory.</li>
<li><code>_write_object(self, oid, content)</code> will be a helper
function called from <code>store()</code> that will handle our actual IO
operations, including zlib compression of the blob before writing to
disk.</li>
</ol>
<p>Let’s implement the <code>store()</code> function first:</p>
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># database.py</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> hashlib</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ...</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> store(<span class="va">self</span>, obj):</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="co">  Stores the given object in this git database.</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co">  :param obj: object to store in the database</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="co">  :return: None</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  serialized_object <span class="op">=</span> <span class="bu">str</span>(obj).encode(<span class="st">&#39;latin1&#39;</span>)</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  content <span class="op">=</span> (<span class="ss">f&quot;</span><span class="sc">{</span> obj<span class="sc">.</span>get_type() <span class="sc">}</span><span class="ss"> </span><span class="sc">{</span> <span class="bu">len</span>(serialized_object) <span class="sc">}</span><span class="ch">\0</span><span class="ss">&quot;</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>             <span class="ss">f&quot;</span><span class="sc">{</span> serialized_object <span class="sc">}</span><span class="ss">&quot;</span>).encode(<span class="st">&#39;latin1&#39;</span>)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  obj.oid <span class="op">=</span> hashlib.sha1(content).hexdigest()</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>  <span class="va">self</span>._write_object(obj.oid, content)</span></code></pre></div>
<p>This implementation of <code>store</code> does the following:</p>
<ol type="1">
<li>Encodes the object into hex bytes <code>0x00-0xff</code>,
representing arbitrary binary data. Blobs can be any kind of file, and
other objects are going to be non-textual data, so we want to encode our
data in a way that can be combined with other objects. Encoding as
arbitrary 8-bit binary data will allow us to do that while avoiding
errors.</li>
<li>Assembles the object’s content by joining the object’s type, length,
and content in a string that gets encoded to binary data.</li>
<li>Hashes the full representation of the object using SHA-1 and stores
the result as the object’s ID.</li>
<li>Calls <code>self._write_object()</code> to write the full
representation of the object to disk.</li>
</ol>
<p>Now, we need to write our code for <code>_write_object()</code>:</p>
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># database.py</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> zlib</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> boltons <span class="im">import</span> fileutils</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co"># ...</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _write_object(<span class="va">self</span>, oid, content):</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co">  Writes the given content to the database,</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co">  using the given object id to create</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="co">  the appropriate directory for the object.</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="co">  :param oid: object id of the object being written</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="co">  :param content: content being written to the database</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="co">  :return: None</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>  object_path <span class="op">=</span> <span class="va">self</span>.pathname.joinpath(oid[:<span class="dv">2</span>], oid[<span class="dv">2</span>:])</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>  dirname <span class="op">=</span> object_path.parent</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  temp_path <span class="op">=</span> dirname.joinpath(<span class="va">self</span>._generate_temp_name())</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">try</span>:</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">file</span> <span class="op">=</span> <span class="bu">open</span>(temp_path, mode<span class="op">=</span><span class="st">&#39;xb+&#39;</span>)</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>  <span class="cf">except</span> <span class="pp">OSError</span>:</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>    fileutils.mkdir_p(dirname)</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">file</span> <span class="op">=</span> <span class="bu">open</span>(temp_path, mode<span class="op">=</span><span class="st">&#39;xb+&#39;</span>)</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>  compressed <span class="op">=</span> zlib.compress(content, <span class="dv">1</span>)  <span class="co"># level 1 is best speed</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>  <span class="bu">file</span>.write(compressed)</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>  <span class="bu">file</span>.close()</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>  fileutils.atomic_rename(temp_path, object_path)</span></code></pre></div>
<p>First, we assemble the directory in which we’ll store our object.
Recall that objects are stored in folders whose names contain the first
two characters of the object’s hash; the object’s filename becomes the
remaining characters of the hash. We store the object’s path as well as
the path to the directory in which that object is to be stored.</p>
<p>Note that we also set a temporary path, which is generated via
another helper method, <code>_generate_temp_name()</code>. If you
examine the rest of the code, you might notice that we actually write
the content to our temporary path, and then perform an atomic move to
our intended final path.</p>
<p>We perform writes in this manner because we want to avoid situations
where another process attempts to access an object while it is being
written to disk. Placing the object in the database with an atomic move
operation ensures that no other process can access the file while it is
being written to disk; other processes will only see the fully-written
blob.</p>
<p>Git accomplishes this by generating a random filename and appending
that filename to the directory in which the file will be placed. Our
<code>_generate_temp_name()</code> function will handle that for us, and
we will examine that after we finish our analysis of
<code>_write_object()</code>.</p>
<p>Once we have a filename to write, we attempt to open the temporary
file. We open the file with <code>'xb+'</code> flags, which indicate
that we want to open the file for exclusive creation (<code>x</code>;
abort if the file already exists) in binary mode (<code>b</code>) with
read/write permissions (<code>+</code>).</p>
<p>Opening the file will fail if the parent directory (with a name equal
to the first 2 characters of the object’s hash) does not exist; we
create it if this is the case.</p>
<p>Once our file is open, we compress the object with <code>zlib</code>
and write the compressed contents to disk.</p>
<p>After our write is successful, we perform our atomic move operation
via <code>fileutils.atomic_rename</code>, renaming our temporary file to
its proper name, reflecting the remaining characters of the object’s
hash.</p>
<p>Let’s take a look at the code for generating our temporary file
names:</p>
<div class="sourceCode" id="cb9"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># database.py</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="co"># ...</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Database:</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>  TEMP_CHARS <span class="op">=</span> [<span class="bu">chr</span>(n) <span class="cf">for</span> n <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">ord</span>(<span class="st">&quot;a&quot;</span>), <span class="bu">ord</span>(<span class="st">&quot;z&quot;</span>) <span class="op">+</span> <span class="dv">1</span>)] <span class="op">\</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>                <span class="op">+</span> [<span class="bu">chr</span>(n) <span class="cf">for</span> n <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">ord</span>(<span class="st">&quot;A&quot;</span>), <span class="bu">ord</span>(<span class="st">&quot;Z&quot;</span>) <span class="op">+</span> <span class="dv">1</span>)] <span class="op">\</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>                <span class="op">+</span> [<span class="bu">chr</span>(n) <span class="cf">for</span> n <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">ord</span>(<span class="st">&quot;0&quot;</span>), <span class="bu">ord</span>(<span class="st">&quot;9&quot;</span>) <span class="op">+</span> <span class="dv">1</span>)]</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  <span class="kw">def</span> _generate_temp_name(<span class="va">self</span>):</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a><span class="co">    Generates a temporary filename to facilitate</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a><span class="co">    atomic writes of objects to the git database.</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a><span class="co">    :return: temporary filename as a string</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a><span class="co">    &quot;&quot;&quot;</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    random_chars <span class="op">=</span> [random.choice(<span class="va">self</span>.TEMP_CHARS) <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">6</span>)]</span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="ss">f&quot;tmp_obj</span><span class="sc">{</span> <span class="st">&#39;&#39;</span><span class="sc">.</span>join(random_chars) <span class="sc">}</span><span class="ss">&quot;</span></span></code></pre></div>
<p>Our <code>_generate_temp_name()</code> function simply chooses 6
random characters from the set of <code>TEMP_CHARS</code> we define as a
constant within the <code>Database</code> class. This list of characters
includes the lowercase and uppercase Latin letters and the digits 0-9.
We then prepend <code>'tmp_obj'</code> to the random string to indicate
that the file on disk is a temporary file.</p>
<h3 id="final-updates">Final updates</h3>
<p>Now that we have a simple <code>Database</code> class, we can extend
our <code>commit</code> handler to store files rather than simply
printing them:</p>
<div class="sourceCode" id="cb10"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># pyle.py</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ...</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="cf">case</span> <span class="st">&#39;commit&#39;</span>:</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Assumes cwd is the location of the repo</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  root_path <span class="op">=</span> PurePath(os.getcwd())</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  git_path <span class="op">=</span> root_path.joinpath(<span class="st">&#39;.git&#39;</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  db_path <span class="op">=</span> git_path.joinpath(<span class="st">&#39;objects&#39;</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  workspace <span class="op">=</span> Workspace(root_path)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  database <span class="op">=</span> Database(db_path)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> path <span class="kw">in</span> workspace.list_files():</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>    data <span class="op">=</span> workspace.read_file(path)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    blob <span class="op">=</span> Blob(data)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    database.store(blob)</span></code></pre></div>
<p>And we can add the missing <code>read_file()</code> method to our
<code>Workspace</code> class:</p>
<div class="sourceCode" id="cb11"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># workspace.py</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ...</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> read_file(path):</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="co">&quot;&quot;&quot;</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a><span class="co">  Reads and returns the contents of the file at the</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="co">  given path.</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co">  &quot;&quot;&quot;</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">with</span> (<span class="bu">open</span>(os.path.join(<span class="va">self</span>.pathname, path))) <span class="im">as</span> f:</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> f.read()</span></code></pre></div>
<p>With these final upates, we now have a working <code>commit</code>
command that stores all working files in our <code>pyle</code> repo when
invoked. Next time, we’ll extend <code>pyle</code> to support storing
trees.</p>
			<p><em><a href="pyle_index.html">Return to blog index</a></em></p>
		</div>
	</div>
</body>
</html>
